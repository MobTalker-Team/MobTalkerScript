<?xml version="1.0" ?>
<project name="MobTalkerScript" default="build-standalone">
	<property name="src" value="${basedir}/../src/main/java" />
	<property name="res" value="${basedir}/../src/main/resources" />
	<property name="tmp" value="${basedir}/../tmp" />
	<property name="bin" value="${basedir}/../bin" />
	<property name="lib" value="${basedir}/../../lib" />

	<property name="output" value="${lib}" />

	<property name="version" value="2.2.3-beta" />

	<property name="name.base" value="MobTalkerScript" />
	<property name="name.lib" value="${name.base}-${version}-lib.jar" />
	<property name="name.lib.fat" value="${name.base}-${version}-lib-fat.jar" />

	<taskdef resource="proguard/ant/task.properties" classpath="D:/Program Files Other/ProGuard/lib/proguard.jar" />

	<path id="classpath">
		<pathelement location="D:/Program Files Other/ANTLR 4/antlr-runtime-4.2.jar" />
		<pathelement location="${lib}/guava-16.0.jar" />
		<pathelement location="${lib}/jopt-simple-4.6.jar" />
		<pathelement location="${lib}/commons-lang3-3.2.1.jar" />
	</path>

	<target name="build-library">
		<antcall target="clean" />
		<antcall target="copy-src" />
		<antcall target="replace-tokens" />
		<antcall target="compile" />

		<!-- Build the jar -->
		<zip destfile="${output}/${name.lib.fat}">
			<fileset dir="${bin}" />
			<fileset dir="${res}" excludes="META-INF/**" />
			<zipfileset excludes="META-INF/**" src="D:/Program Files Other/ANTLR 4/antlr-runtime-4.2.jar" />
		</zip>

		<antcall target="proguard-lib" />

		<antcall target="clean" />
	</target>

	<target name="build-standalone">
		<antcall target="clean" />
		<antcall target="copy-src" />
		<antcall target="replace-tokens" />
		<antcall target="compile" />

		<!-- Build the jar -->
		<zip destfile="${MobTalker2.libraries.location}/MobTalkerScript-${version}-standalone-fat.jar">
			<fileset dir="${bin}" />
			<fileset dir="${res}" />
			<zipfileset src="D:/Program Files Other/ANTLR 4/antlr-runtime-4.2.jar" excludes="META-INF/**" />
			<zipfileset excludes="META-INF/**" src="${lib}/guava-16.0.jar" />
			<zipfileset excludes="META-INF/**" src="${lib}/jopt-simple-4.6.jar" />
			<zipfileset excludes="META-INF/**,templates/**" src="${lib}/commons-lang3-3.2.1.jar" />
		</zip>

		<antcall target="proguard-standalone" />

		<antcall target="clean" />
	</target>

	<target name="proguard-lib">
		<delete file="${output}/${name.lib}" failonerror="no" />

		<proguard>
			-injars 	 ${lib}/${name.lib.fat}
			-outjars	 ${lib}/${name.lib}
			-libraryjars D:/Program Files/Java/jre7/lib/rt.jar
			-libraryjars ${lib}/guava-16.0.jar
			-libraryjars ${lib}/jopt-simple-4.6.jar
			-libraryjars ${lib}/commons-lang3-3.2.1.jar

			-target 1.7
			-dontobfuscate
			
			-optimizations !code/allocation/variable
			-optimizationpasses 6

			-dontnote org.antlr.v4.runtime.misc.**
			
			-dontwarn javax.annotation.**
			-dontwarn javax.inject.**
			-dontwarn sun.misc.Unsafe

			-keep
			 public class net.mobtalker.mobtalkerscript.util.**,
						  net.mobtalker.mobtalkerscript.v2.*,
					      net.mobtalker.mobtalkerscript.v2.compiler.**,
			              net.mobtalker.mobtalkerscript.v2.instruction.**,
			              net.mobtalker.mobtalkerscript.v2.lib.*,
			              net.mobtalker.mobtalkerscript.v2.value.** 
			{
			    public protected *;
			}

			-keepclassmembers 
			 class net.mobtalker.mobtalkerscript.v2.lib.** 
			{
			    @net.mobtalker.mobtalkerscript.v2.value.userdata.* *;
			}

			-keep, allowshrinking 
			 class org.antlr.v4.** 
			{}

			-keepclassmembers 
			 class org.antlr.v4.runtime.ANTLRInputStream 
			{
			    public &lt;init&gt;( ... );
			}
		</proguard>

		<delete file="${lib}/${name.lib.fat}" />
	</target>

	<target name="proguard-standalone">
		<delete file="${MobTalker2.libraries.location}/MobTalkerScript-${version}-standalone.jar" failonerror="no" />

		<proguard>
			-injars 	 ${MobTalker2.libraries.location}/MobTalkerScript-${version}-standalone-fat.jar
			-outjars	 ${MobTalker2.libraries.location}/MobTalkerScript-${version}-standalone.jar
			-libraryjars D:\Program Files\Java\jre7\lib\rt.jar

			-target 1.6
			-dontobfuscate
			
			-optimizations !code/allocation/variable
			-optimizationpasses 6

			-dontnote com.google.common.**
			-dontnote joptsimple.**
			-dontnote org.antlr.v4.runtime.misc.**
			-dontnote org.apache.commons.lang3.**
			
			-dontwarn javax.annotation.**
			-dontwarn javax.inject.**
			-dontwarn sun.misc.Unsafe
			
			-keepnames class mobtalkerscript.** {}

			-keepclassmembers class * {
			    @mobtalkerscript.v2.value.userdata.* *;
			}

			-keepclasseswithmembers public class * {
			    public static void main(java.lang.String[]);
			}

			-keepclassmembers enum * {
			    public static **[] values();
			    public static ** valueOf(java.lang.String);
			}
		</proguard>

		<delete file="${MobTalker2.libraries.location}/MobTalkerScript-${version}-standalone-fat.jar" />
	</target>

	<target name="clean">
		<delete includeemptydirs="true">
			<fileset dir="${tmp}" erroronmissingdir="false" />
			<fileset dir="${bin}" erroronmissingdir="false" />
		</delete>
	</target>

	<target name="copy-src">
		<copy todir="${tmp}">
			<fileset dir="${src}" />
		</copy>
	</target>

	<target name="replace-tokens">
		<replace summary="yes" failOnNoReplacements="true" preserveLastModified="true">
			<fileset dir="${tmp}/net/mobtalker/mobtalkerscript/v2/">
				<include name="MtsGlobals.java" />
			</fileset>

			<replacefilter token="@VERSION@" value="${version}" />
		</replace>
	</target>

	<target name="compile">
		<mkdir dir="${bin}" />

		<javac srcdir="${tmp}" destdir="${bin}" source="7" target="7" includeantruntime="false">
			<classpath refid="classpath" />
		</javac>
	</target>

</project>
