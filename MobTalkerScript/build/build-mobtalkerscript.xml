<?xml version="1.0" ?>
<project name="MobTalkerScript" default="build-standalone">
	<property name="Minecraft.libraries.location" value="${basedir}/../../../Minecraft-1_6/forge/mcp/jars/libraries" />
	<property name="MobTalker2.libraries.location" value="${basedir}/../../../lib" />

	<property name="src" value="${basedir}/../src" />
	<property name="res" value="${basedir}/../res" />
	<property name="bin" value="${basedir}/../bin" />

	<property name="version" value="2.1.1-beta" />

	<taskdef resource="proguard/ant/task.properties" classpath="D:/Program Files Other/ProGuard/lib/proguard.jar" />

	<path id="classpath">
		<pathelement location="D:/Program Files Other/ANTLR 4/antlr-runtime-4.2.jar" />
		<pathelement location="${Minecraft.libraries.location}/com/google/guava/guava/14.0/guava-14.0.jar" />
		<pathelement location="${Minecraft.libraries.location}/net/sf/jopt-simple/jopt-simple/4.5/jopt-simple-4.5.jar" />
		<pathelement location="${Minecraft.libraries.location}/org/apache/commons/commons-lang3/3.1/commons-lang3-3.1.jar" />
	</path>

	<target name="build-standalone">
		<delete includeemptydirs="true">
			<fileset dir="${bin}" erroronmissingdir="false" />
		</delete>
		<mkdir dir="${bin}" />

		<!--<antcall target="ReplaceTokens" />-->

		<javac srcdir="${src}" destdir="${bin}" source="6" target="6" includeantruntime="false">
			<classpath refid="classpath" />
		</javac>

		<!-- Build the jar -->
		<zip destfile="${MobTalker2.libraries.location}/MobTalkerScript-${version}-standalone-fat.jar">
			<fileset dir="${bin}" />
			<fileset dir="${res}" />
			<zipfileset src="D:/Program Files Other/ANTLR 4/antlr-runtime-4.2.jar" excludes="META-INF/**" />
			<zipfileset excludes="META-INF/**" src="${Minecraft.libraries.location}/com/google/guava/guava/14.0/guava-14.0.jar" />
			<zipfileset excludes="META-INF/**" src="${Minecraft.libraries.location}/net/sf/jopt-simple/jopt-simple/4.5/jopt-simple-4.5.jar" />
			<zipfileset excludes="META-INF/**,templates/**" src="${Minecraft.libraries.location}/org/apache/commons/commons-lang3/3.1/commons-lang3-3.1.jar" />
		</zip>

		<delete file="${MobTalker2.libraries.location}/MobTalkerScript-${version}-standalone.jar" failonerror="no" />

		<proguard>
			-injars 	 ${MobTalker2.libraries.location}/MobTalkerScript-${version}-standalone-fat.jar
			-outjars	 ${MobTalker2.libraries.location}/MobTalkerScript-${version}-standalone.jar
			-libraryjars D:\Program Files\Java\jre7\lib\rt.jar

			-verbose
			-target 1.6
			-dontobfuscate
			
			-optimizations !code/allocation/variable
			-optimizationpasses 10

			-dontwarn javax.annotation.**
			-dontwarn javax.inject.**
			-dontwarn sun.misc.Unsafe

			-keepclassmembers class * {
			    @mobtalkerscript.v2.value.userdata.* *;
			}

			-keepclasseswithmembers public class * {
			    public static void main(java.lang.String[]);
			}

			-keepclassmembers enum * {
			    public static **[] values();
			    public static ** valueOf(java.lang.String);
			}
		</proguard>

		<delete file="${MobTalker2.libraries.location}/MobTalkerScript-${version}-standalone-fat.jar" />

		<delete includeemptydirs="true" failonerror="false">
			<fileset dir="${bin}" />
		</delete>
	</target>

	<target name="build-library">
		<delete includeemptydirs="true">
			<fileset dir="${bin}" erroronmissingdir="false" />
		</delete>
		<mkdir dir="${bin}" />

		<javac srcdir="${src}" destdir="${bin}" source="6" target="6" includeantruntime="false">
			<classpath refid="classpath" />
		</javac>

		<!-- Build the jar -->
		<zip destfile="${MobTalker2.libraries.location}/MobTalkerScript-${version}-lib-fat.jar">
			<fileset dir="${bin}" />
			<fileset dir="${res}" excludes="META-INF/**" />
			<zipfileset excludes="META-INF/**" src="D:/Program Files Other/ANTLR 4/antlr-runtime-4.2.jar" />
		</zip>

		<delete file="${MobTalker2.libraries.location}/MobTalkerScript-${version}-lib.jar" failonerror="no" />

		<proguard>
			-injars 	 ${MobTalker2.libraries.location}/MobTalkerScript-${version}-lib-fat.jar
			-outjars	 ${MobTalker2.libraries.location}/MobTalkerScript-${version}-lib.jar
			-libraryjars D:/Program Files/Java/jre7/lib/rt.jar
			-libraryjars ${Minecraft.libraries.location}/com/google/guava/guava/14.0/guava-14.0.jar
			-libraryjars ${Minecraft.libraries.location}/net/sf/jopt-simple/jopt-simple/4.5/jopt-simple-4.5.jar
			-libraryjars ${Minecraft.libraries.location}/org/apache/commons/commons-lang3/3.1/commons-lang3-3.1.jar

			-verbose
			-target 1.6
			-dontobfuscate
			
			-optimizations !code/allocation/variable
			-optimizationpasses 10

			-dontwarn javax.annotation.**
			-dontwarn javax.inject.**
			-dontwarn sun.misc.Unsafe

			-keep public class mobtalkerscript.** {
			    public protected *;
			}

			-keepclassmembers class org.antlr.v4.runtime.ANTLRInputStream {
			    public &lt;init&gt;( ... );
			}

			-keepclassmembers class * {
			    @mobtalkerscript.v2.value.userdata.* *;
			}

			-keepclasseswithmembers public class * {
			    public static void main(java.lang.String[]);
			}

			-keepclassmembers enum * {
			    public static **[] values();
			    public static ** valueOf(java.lang.String);
			}
		</proguard>

		<delete file="${MobTalker2.libraries.location}/MobTalkerScript-${version}-lib-fat.jar" />

		<delete includeemptydirs="true" failonerror="false">
			<fileset dir="${bin}" />
		</delete>
	</target>

	<target name="ReplaceTokens">
		<replace summary="yes" failOnNoReplacements="true" preserveLastModified="true">
			<fileset dir="${src}/mobtalkerscript/v2/">
				<include name="MtsGlobals.java" />
			</fileset>

			<replacefilter token="@VERSION@" value="${version}" />
		</replace>
	</target>

</project>
